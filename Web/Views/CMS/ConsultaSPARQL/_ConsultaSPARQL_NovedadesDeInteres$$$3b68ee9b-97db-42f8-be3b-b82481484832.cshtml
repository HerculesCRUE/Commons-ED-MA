@using System.Linq;
@using System.Collections;
@model CMSComponentQuerySPARQL
@{ CommunityModel Comunidad = Html.GetComunidad();
    UserIdentityModel IdentidadActual = Html.GetIdentidadActual();
}

@if (Model != null)
{
    // Html.ObtenerUrlDeDoc()
    System.Data.DataTable col = Model.DataSetResult.Tables[0];
    listadoNovedades = new List<Resource>();
    @foreach (System.Data.DataRow fila in Model.DataSetResult.Tables[0].Rows)
    {
        Resource resource = new Resource(fila);
        listadoNovedades.Add(resource);
    }

    @if (!IdentidadActual.IsGuestUser)
    {
        <div class="resource-list listView resource-list-personas">
            <div class="resource-list-wrap">
                <article class="resource">
                    <div class="wrap">
                        <div class="upper-wrap">
                            <p class="autor">Maria García</p>
                            <p class="fecha">Lun 22, jun. 2020</p>
                            <div class="acciones-recurso-listado">
                                <div class="dropdown">
                                    <a href="#" class="dropdown-toggle" role="button" id="dropdownMasOpciones" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <span class="material-icons">more_vert</span>
                                    </a>
                                    <div class="dropdown-menu basic-dropdown dropdown-icons dropdown-menu-right" aria-labelledby="dropdownMasOpciones" style="will-change: transform;">
                                        <p class="dropdown-title">Acciones</p>
                                        <ul class="no-list-style">
                                            <li>
                                                <a class="item-dropdown">
                                                    <span class="material-icons">create</span>
                                                    <span class="texto">Editar</span>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="item-dropdown" data-toggle="modal" data-target="#modal-enviar">
                                                    <span class="material-icons">send</span>
                                                    <span class="texto">Enviar</span>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="item-dropdown" data-toggle="modal" data-target="#modal-etiquetar">
                                                    <span class="material-icons">label</span>
                                                    <span class="texto">Etiquetar</span>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="item-dropdown" data-toggle="modal" data-target="#modal-categorizar">
                                                    <span class="material-icons">folder_open</span>
                                                    <span class="texto">Categorizar</span>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="item-dropdown" data-toggle="modal" data-target="#modal-versionar">
                                                    <span class="material-icons">file_copy</span>
                                                    <span class="texto">Versionar</span>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="item-dropdown" data-toggle="modal" data-target="#modal-container">
                                                    <span class="material-icons">dns</span>
                                                    <span class="texto">Historial</span>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="item-dropdown" data-toggle="modal" data-target="#modal-bloquear-comentarios">
                                                    <span class="material-icons">speaker_notes_off</span>
                                                    <span class="texto">Bloquear comentarios</span>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="item-dropdown" data-toggle="modal" data-target="#modal-vincular">
                                                    <span class="material-icons">attach_file</span>
                                                    <span class="texto">Vincular</span>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="item-dropdown" data-toggle="modal" data-target="#modal-certificar">
                                                    <span class="material-icons">verified_user</span>
                                                    <span class="texto">Certificar</span>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="item-dropdown" data-toggle="modal" data-target="#modal-eliminar">
                                                    <span class="material-icons">delete</span>
                                                    <span class="texto">Eliminar</span>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="item-dropdown" data-toggle="modal" data-target="#modal-compartir">
                                                    <span class="material-icons">share</span>
                                                    <span class="texto">Compartir</span>
                                                </a>
                                            </li>
                                            <li>
                                                <a class="item-dropdown">
                                                    <span class="material-icons">forward</span>
                                                    <span class="texto">Ir a la web</span>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="middle-wrap">
                            <div class="title-wrap">
                                <h2 class="resource-title">
                                    <a href="./ficha.php">Responsable de departamento - Mercado</a>
                                </h2>
                            </div>
                            <div class="content-wrap">
                                <div class="image-wrap">
                                    <div class="image">
                                        <img alt="texto alternativo de la imagen de un recurso" src="./theme/resources/imagenes-pre/resource-image-1.jpg">
                                    </div>
                                </div>
                                <div class="description-wrap counted">
                                    <div class="desc">
                                        <p>Lorem ipsum dolor sit amet, cons et lorem suscipit sollicitudin. Fusce dictum tellus nulla, vitae lobortis nunc rornare. Suspendisse nec nisl vel diam rutrum fermentum. Maecenas sit amet elementum lectus</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="down-wrap">
                            <div class="social">
                                <div class="visualizacion-recurso">
                                    <span class="material-icons">visibility</span>
                                    <span class="number">135</span>
                                </div>
                                <div class="interacciones-recurso">
                                    <div class="likes">
                                        <span class="material-icons">thumb_up_alt</span>
                                        <span class="number">12</span>
                                    </div>
                                    <div class="dislikes">
                                        <span class="material-icons">thumb_down_alt</span>
                                        <span class="number">3</span>
                                    </div>
                                </div>
                                <div class="seguir-usuario">
                                    <span class="material-icons">person_add_alt_1</span>
                                    <span class="texto">Seguir a Javier García Pérez</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </article>
            </div>
        </div>
    }


}

@functions
{
    public static List<Resource> listadoNovedades = new List<Resource>();

    public class Resource
    {
        public string id { get; set; }
        public string fecha { get; set; }
        public string description { get; set; }
        public string title { get; set; }
        public string type { get; set; }
        public string url { get; set; }
        public List<Perfil> profiles { get; set; }

        public Resource()
        {
            id = "";
            fecha = "";
            description = "";
            title = "";
            profiles = new();
        }

        public Resource(System.Data.DataRow fila)
        {
            Perfil nperfil = new();
            nperfil.researchers = new();
            // Add perfil
            this.profiles = new();

            try
            {
                if (!fila.IsNull("perfil"))
                {
                    nperfil.id = fila["perfil"].ToString();
                    if (!fila.IsNull("perfilTitle"))
                    {
                        nperfil.title = fila["perfilTitle"].ToString();
                    }
                    if (!fila.IsNull("perfilUsers"))
                    {
                        var researchers = fila["perfilUsers"].ToString().Split(",").ToList();
                        nperfil.researchers = researchers.Select(e => new User() {  id= e.Split('@')[1].Replace("http://gnoss/",""), name= e.Split('@')[0]}).ToList();
                    }
                }

            } catch(Exception e) { }

            try
            {
                if (!fila.IsNull("description"))
                {
                    this.description = fila["description"].ToString();
                }
            } catch(Exception e) { }


            this.profiles.Add(nperfil);

            this.id = fila["resource"].ToString();
            this.fecha = GetFecha(fila["fecha"].ToString());
            this.title = fila["title"].ToString();
        }

        private string GetFecha(string fecha)
        {
            if (!string.IsNullOrEmpty(fecha) && fecha.Length == 14)
            {
                string anio = fecha.Substring(0, 4);
                string mes = fecha.Substring(4, 2);
                string dia = fecha.Substring(6, 2);
                string hora = fecha.Substring(8, 2);
                string min = fecha.Substring(10, 2);
                string segs = fecha.Substring(12, 2);
                fecha = dia + "/" + mes + "/" + anio + " " + hora + ":" + min + ":" + segs;
            }
            return fecha;
        }
    }
    
    public class Perfil
    {
        public string id { get; set; }
        public string title { get; set; }
        public List<User> researchers { get; set; }
    }

    public class User
    {
        public string id { get; set; }
        public string name { get; set; }
    }
}
